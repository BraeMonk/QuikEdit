<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pixel Sprite Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: sans-serif; padding: 10px; text-align: center; background: #1c1c1c; color: #fff; }
  #controls { margin-bottom: 10px; }
  #canvas { display: grid; touch-action: none; margin: 10px auto; border: 1px solid #555; }
  .cell { border: 1px solid #333; box-sizing: border-box; }
  button, select, input { margin: 5px; padding: 8px 16px; font-size: 14px; cursor: pointer; }
  #swatches { margin-top: 10px; }
  .swatch { display: inline-block; width: 30px; height: 30px; margin: 2px; border: 1px solid #333; cursor: pointer; }
  .swatch.selected { border: 3px solid #fff; }
  pre { text-align: left; max-width: 100%; overflow-x: auto; background: #222; padding: 10px; color: #fff; }
</style>
</head>
<body>

<h2>Pixel Sprite Editor</h2>

<div id="controls">
  Theme:
  <select id="paletteSelector"></select>

  Sprite:
  <select id="spriteSelector"></select>
  <button id="newSprite">New Sprite</button>

  <button id="undo">Undo</button>
  <button id="redo">Redo</button>
  <button id="clear">Clear</button>
  <button id="export">Export Array</button>
  <input type="file" id="importFile" accept=".json">
</div>

<div id="swatches"></div>
<div id="canvas"></div>
<pre id="output"></pre>

<script>
// ----------------------------
// Light/Dark mode toggle
// ----------------------------
const isLightMode = true; // change to false for dark variants

// ----------------------------
// Inline themes (arrays now)
// ----------------------------
const palettes = {
  default: isLightMode
    ? ['transparent', '#FFF2E0', '#FFE0B3', '#FFD8A6', '#FFCB88', '#E6B273', '#C4945E', '#A9745B', '#8B5E3C', '#6B4226', '#4A2B17']
    : ['transparent', '#E0ECFA', '#C2DAF7', '#9CC7F0', '#6FA6E0', '#4A90E2', '#2B6FB2', '#1F5FBF', '#173F80', '#0D264D', '#08162B'],
  candy: isLightMode
    ? ['transparent', '#FF6B6B', '#FFA94D', '#FFD93D', '#6BCB77', '#4D96FF', '#9D4EDD', '#FF8FAB', '#FFB5E8', '#FFDEE9', '#FFFFFF']
    : ['transparent', '#FF8787', '#FFB86B', '#FFE066', '#8CE99A', '#74C0FC', '#B197FC', '#FF99C8', '#FFB3DE', '#FFC2E5', '#F8F9FA'],
  desert: isLightMode
    ? ['transparent', '#F4E1D2', '#E2B07E', '#D89C5C', '#C97B3D', '#A0522D', '#8B5E3C', '#6B4226', '#4B2E1F', '#2E1A12', '#000000']
    : ['transparent', '#E6CBB3', '#D4A373', '#BF8040', '#A0522D', '#7B4B24', '#5C3720', '#3E2414', '#24140D', '#120A06', '#000000'],
  ocean: isLightMode
    ? ['transparent', '#A2D2FF', '#80C0FF', '#5AA9FA', '#4682B4', '#2E5984', '#1B3B5F', '#0F2A44', '#082136', '#041626', '#000814']
    : ['transparent', '#90C8F8', '#66AEEF', '#3D91E0', '#2E6FA3', '#1D4E72', '#103552', '#0A2438', '#061C2B', '#03111B', '#000814'],
  ember: isLightMode
    ? ['transparent', '#FFF3B0', '#FFD93D', '#FFA200', '#FF6B35', '#E63946', '#B51709', '#800F00', '#4D0600', '#260300', '#0D0000']
    : ['transparent', '#FFE066', '#FFC300', '#FF8C00', '#FF5733', '#C70039', '#900C3F', '#581845', '#2C0B27', '#160513', '#0B0208'],
  meadow: isLightMode
    ? ['transparent', '#E0F7E9', '#B2F2BB', '#8CE99A', '#69DB7C', '#38D9A9', '#20C997', '#12B886', '#0CA678', '#087F5B', '#045040']
    : ['transparent', '#C3F5D5', '#96E6A8', '#70D78B', '#4CB372', '#31A67F', '#24916B', '#1A7257', '#115745', '#0A3A2D', '#041E16'],
  neon: isLightMode
    ? ['transparent', '#FF00FF', '#FF1493', '#FF4500', '#FFD700', '#ADFF2F', '#00FF7F', '#00FFFF', '#1E90FF', '#8A2BE2', '#FFFFFF']
    : ['transparent', '#FF4DFF', '#FF69B4', '#FF6347', '#FFE066', '#C0FF66', '#66FFB2', '#66FFFF', '#66A3FF', '#B266FF', '#F8F9FA'],
  pastel: isLightMode
    ? ['transparent', '#FFB5E8', '#FFDEB4', '#FFF5BA', '#B5EAD7', '#C7CEEA', '#E0BBE4', '#FEC8D8', '#D8E2DC', '#F1F0C0', '#FFFFFF']
    : ['transparent', '#FF99CC', '#FFCC99', '#FFF2A8', '#99E2C3', '#A8B9E6', '#C7A9D6', '#F5A3C7', '#CFCFCF', '#EAE6B8', '#F8F9FA'],
  gothic: isLightMode
    ? ['transparent', '#1A1A1A', '#2E2E2E', '#444444', '#5E2750', '#87255B', '#D90368', '#FF6F61', '#C9ADA7', '#EAEAEA', '#FFFFFF']
    : ['transparent', '#000000', '#1A1A1A', '#333333', '#5E2750', '#7A1E48', '#B30C5C', '#FF4F5E', '#A99A93', '#D6D6D6', '#F5F5F5'],
  aurora: isLightMode
    ? ['transparent', '#A5FFD6', '#82FFC7', '#5DFDCB', '#3EDBF0', '#3B9AE1', '#6F69AC', '#9D4EDD', '#FF5D8F', '#FF87AB', '#FFFFFF']
    : ['transparent', '#7DFFBF', '#5AF7B0', '#32E1B5', '#1EB7D8', '#2070B0', '#514080', '#7A29C6', '#FF4D7A', '#FF6F9F', '#F8F9FA'],
  clay: isLightMode
    ? ['transparent', '#F5E0C0', '#E0C097', '#CC9B6D', '#B0724A', '#8C4A2F', '#6E3923', '#4E2817', '#321B10', '#1A0D08', '#000000']
    : ['transparent', '#EAD2B0', '#D1A374', '#B97849', '#8E5432', '#6B3C24', '#502C1A', '#361E12', '#22120B', '#120805', '#000000'],
};

// ----------------------------
// State
// ----------------------------
let colors = palettes.default;
let array = [];
let canvasWidth = 16;
let canvasHeight = 16;
let selectedColor = 0;
let undoStack = [];
let redoStack = [];
let allSprites = [];
let currentSpriteIndex = 0;

const canvas = document.getElementById('canvas');
const paletteSelector = document.getElementById('paletteSelector');
const spriteSelector = document.getElementById('spriteSelector');
let isPainting = false;

// ----------------------------
// Populate Theme Selector
// ----------------------------
for(let theme in palettes){
  const opt = document.createElement('option');
  opt.value = theme;
  opt.textContent = theme;
  paletteSelector.appendChild(opt);
}
paletteSelector.value='default';

// ----------------------------
// Functions
// ----------------------------
function renderSwatches(){
  const swatchesDiv = document.getElementById('swatches');
  swatchesDiv.innerHTML='';
  colors.forEach((color,index)=>{
    const swatch = document.createElement('div');
    swatch.className='swatch';
    if(index===selectedColor) swatch.classList.add('selected');
    swatch.style.background=color;
    swatch.addEventListener('click',()=>{ selectedColor=index; renderSwatches(); });
    swatchesDiv.appendChild(swatch);
  });
}

function saveState(){
  undoStack.push(array.map(r=>r.slice()));
  if(undoStack.length>50) undoStack.shift();
  redoStack=[];
}

function paintCell(cell){
  saveState();
  const x=parseInt(cell.dataset.x);
  const y=parseInt(cell.dataset.y);
  array[y][x]=selectedColor;
  cell.dataset.value=selectedColor;
  cell.style.background=colors[selectedColor];
}

function renderCanvas(){
  canvas.innerHTML='';
  const cellSize=Math.floor(Math.min(480, window.innerWidth-20)/Math.max(canvasWidth,canvasHeight));
  canvas.style.gridTemplateColumns=`repeat(${canvasWidth},${cellSize}px)`;
  canvas.style.gridTemplateRows=`repeat(${canvasHeight},${cellSize}px)`;

  for(let y=0;y<canvasHeight;y++){
    for(let x=0;x<canvasWidth;x++){
      const cell=document.createElement('div');
      cell.className='cell';
      cell.dataset.x=x;
      cell.dataset.y=y;
      cell.dataset.value=array[y][x];
      cell.style.width=`${cellSize}px`;
      cell.style.height=`${cellSize}px`;
      cell.style.background=colors[array[y][x]];

      cell.addEventListener('mousedown',()=>{ isPainting=true; paintCell(cell); });
      cell.addEventListener('mouseenter',()=>{ if(isPainting) paintCell(cell); });
      cell.addEventListener('mouseup',()=>{ isPainting=false; });

      cell.addEventListener('touchstart',(e)=>{ paintCell(cell); e.preventDefault(); });
      cell.addEventListener('touchmove',(e)=>{
        const t=e.touches[0];
        const target=document.elementFromPoint(t.clientX,t.clientY);
        if(target && target.classList.contains('cell')) paintCell(target);
        e.preventDefault();
      });

      canvas.appendChild(cell);
    }
  }
  renderSwatches();
  document.body.addEventListener('mouseup',()=>isPainting=false);
}

function updateCanvasColors(){
  document.querySelectorAll('.cell').forEach(cell=>{
    cell.style.background=colors[parseInt(cell.dataset.value)];
  });
}

// ----------------------------
// Sprite functions
// ----------------------------
function loadSprite(index){
  if(!allSprites[index]) return;
  array = allSprites[index].map(r=>r.slice());
  canvasHeight = array.length;
  canvasWidth = array[0].length;
  undoStack=[];
  redoStack=[];
  renderCanvas();
  currentSpriteIndex=index;
}

function addNewSprite(){
  const newSprite = Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  allSprites.push(newSprite);
  const opt = document.createElement('option');
  opt.value = allSprites.length-1;
  opt.textContent = `Sprite ${allSprites.length}`;
  spriteSelector.appendChild(opt);
  spriteSelector.value = allSprites.length-1;
  loadSprite(allSprites.length-1);
}

// ----------------------------
// Init
// ----------------------------
function initCanvas(width=16,height=16){
  canvasWidth=width;
  canvasHeight=height;
  array = Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  allSprites = [array.map(r=>r.slice())];
  spriteSelector.innerHTML='<option value="0">Sprite 1</option>';
  currentSpriteIndex = 0;
  renderCanvas();
}
initCanvas();

// ----------------------------
// Event Listeners
// ----------------------------
paletteSelector.addEventListener('change',()=>{
  colors = palettes[paletteSelector.value];
  selectedColor = 0;
  renderSwatches();
  updateCanvasColors();
});

spriteSelector.addEventListener('change',()=>{
  loadSprite(parseInt(spriteSelector.value));
});

document.getElementById('newSprite').addEventListener('click',addNewSprite);

document.getElementById('undo').addEventListener('click',()=>{
  if(undoStack.length){
    redoStack.push(array.map(r=>r.slice()));
    array = undoStack.pop().map(r=>r.slice());
    renderCanvas();
  }
});
document.getElementById('redo').addEventListener('click',()=>{
  if(redoStack.length){
    undoStack.push(array.map(r=>r.slice()));
    array = redoStack.pop().map(r=>r.slice());
    renderCanvas();
  }
});
document.getElementById('clear').addEventListener('click',()=>{
  saveState();
  array=Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  renderCanvas();
});

// Export
document.getElementById('export').addEventListener('click',()=>{
  allSprites[currentSpriteIndex] = array.map(r=>r.slice());
  document.getElementById('output').textContent=JSON.stringify(allSprites,null,4);
});

// Import
document.getElementById('importFile').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            let importedData = JSON.parse(evt.target.result);

            // Convert object-of-sprites to array-of-sprites
            if (!Array.isArray(importedData) && typeof importedData === 'object') {
                importedData = Object.values(importedData);
            }

            allSprites = importedData.map(spr => {
                if (Array.isArray(spr[0])) {
                    // Already 2D array
                    return spr.map(r => r.slice());
                }
                // Flattened array: attempt to detect rectangle dimensions
                let total = spr.length;
                const possibleSizes = [];
                for (let h = 1; h <= total; h++) {
                    if (total % h === 0) possibleSizes.push([total / h, h]);
                }
                if (possibleSizes.length > 0) {
                    const [w, h] = possibleSizes[0];
                    const grid = [];
                    for (let y = 0; y < h; y++) {
                        grid.push(spr.slice(y * w, (y + 1) * w));
                    }
                    return grid;
                }
                throw 'Cannot auto-detect sprite dimensions';
            });

            loadSprite(0);

            // Populate sprite dropdown
            spriteSelector.innerHTML = '';
            allSprites.forEach((_, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `Sprite ${i + 1}`;
                spriteSelector.appendChild(opt);
            });
            spriteSelector.value = 0;

        } catch (err) {
            alert('Invalid JSON file: ' + err);
        }
    };
    reader.readAsText(file);
});

</script>

</body>
</html>
