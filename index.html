<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pixel Sprite Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: sans-serif; padding: 10px; text-align: center; background: #1c1c1c; color: #fff; }
  #controls { margin-bottom: 10px; }
  #canvas { display: grid; touch-action: none; margin: 10px auto; border: 1px solid #555; }
  .cell { border: 1px solid #333; box-sizing: border-box; }
  button, select, input { margin: 5px; padding: 8px 16px; font-size: 14px; cursor: pointer; }
  #swatches { margin-top: 10px; }
  .swatch { display: inline-block; width: 30px; height: 30px; margin: 2px; border: 1px solid #333; cursor: pointer; }
  .swatch.selected { border: 3px solid #fff; }
  pre { text-align: left; max-width: 100%; overflow-x: auto; background: #222; padding: 10px; color: #fff; }
</style>
</head>
<body>

<h2>Pixel Sprite Editor</h2>

<div id="controls">
  Theme:
  <select id="paletteSelector"></select>

  Sprite:
  <select id="spriteSelector"></select>
  <button id="newSprite">New Sprite</button>

  <button id="undo">Undo</button>
  <button id="redo">Redo</button>
  <button id="clear">Clear</button>
  <button id="export">Export Array</button>
  <input type="file" id="importFile" accept=".json">
</div>

<div id="swatches"></div>
<div id="canvas"></div>
<pre id="output"></pre>

<script>
// ----------------------------
// Light/Dark mode toggle
// ----------------------------
const isLightMode = true; // change to false for dark variants

// ----------------------------
// Inline themes (arrays now)
// ----------------------------
const palettes = {
  default: isLightMode
    ? ['transparent', '#FFF2E0', '#FFE0B3', '#FFD8A6', '#FFCB88', '#E6B273', '#C4945E', '#A9745B', '#8B5E3C', '#6B4226', '#4A2B17']
    : ['transparent', '#E0ECFA', '#C2DAF7', '#9CC7F0', '#6FA6E0', '#4A90E2', '#2B6FB2', '#1F5FBF', '#173F80', '#0D264D', '#08162B'],

  chaotic: isLightMode
    ? ['transparent', '#FFE5E0', '#FFB3A1', '#FF7F66', '#FF6347', '#FF4500', '#E63E00', '#B22222', '#8B0000', '#660000', '#330000']
    : ['transparent', '#FFB3A1', '#FF7F66', '#FF6347', '#FF4500', '#E63E00', '#B22222', '#8B0000', '#660000', '#330000', '#1A0000'],

  neutral: isLightMode
    ? ['transparent', '#F8F0FF', '#E0CFFF', '#D8BFFF', '#B58ED9', '#9C6AC7', '#7D3C98', '#6A0DAD', '#4B0082', '#3A0066', '#250044']
    : ['transparent', '#E0CFFF', '#D8BFFF', '#B58ED9', '#9C6AC7', '#7D3C98', '#6A0DAD', '#4B0082', '#330055', '#1E0033', '#0F001A'],

  noir: isLightMode
    ? ['transparent', '#FFFFFF', '#DDDDDD', '#BBBBBB', '#999999', '#777777', '#555555', '#333333', '#111111', '#000000']
    : ['transparent', '#FFFFFF', '#DDDDDD', '#BBBBBB', '#999999', '#777777', '#555555', '#333333', '#111111', '#000000'],

  forest: isLightMode
    ? ['transparent', '#E5F7EC', '#C3EED3', '#A9DFBF', '#82E0AA', '#58C48F', '#2E8B57', '#1B5E20', '#145C17', '#0C3B0F', '#061F08']
    : ['transparent', '#C3EED3', '#A9DFBF', '#82E0AA', '#58C48F', '#2E8B57', '#1B5E20', '#145C17', '#0C3B0F', '#061F08', '#020C04'],

  neon: isLightMode
    ? ['transparent', '#FFB3FF', '#FF66FF', '#FF00FF', '#CC00CC', '#990099', '#660066', '#33FFFF', '#00FFFF', '#00CCCC', '#009999']
    : ['transparent', '#B3FFFF', '#66FFFF', '#00FFFF', '#33CCCC', '#00CCCC', '#009999', '#FF66FF', '#FF00FF', '#CC00CC', '#990099'],

  solar: isLightMode
    ? ['transparent', '#FFF5CC', '#FFE6A3', '#FFD580', '#FFCB66', '#FF8C00', '#E67E22', '#CC7000', '#B35900', '#803D00', '#4D2400']
    : ['transparent', '#FFE6A3', '#FFD580', '#FFCB66', '#FF8C00', '#E67E22', '#CC7000', '#B35900', '#803D00', '#4D2400', '#261200'],

  glacial: isLightMode
    ? ['transparent', '#F0FAFF', '#D6EAF8', '#B3E5FC', '#A9DDF2', '#85C1E9', '#5DADE2', '#2E86C1', '#154360', '#0E2B3F', '#061522']
    : ['transparent', '#EBF5FB', '#D6EAF8', '#B3E5FC', '#AED6F1', '#85C1E9', '#5DADE2', '#2E86C1', '#154360', '#0E2B3F', '#061522'],

  cosmic: isLightMode
    ? ['transparent', '#F0E6FF', '#E0B0FF', '#D8A0FF', '#B47CD9', '#8A2BE2', '#5C1F80', '#2C003E', '#1A0010', '#12001A', '#0A000C']
    : ['transparent', '#E0B0FF', '#D8A0FF', '#B47CD9', '#8A2BE2', '#5C1F80', '#2C003E', '#1A0010', '#12001A', '#0A000C'],

  blossom: isLightMode
    ? ['transparent', '#FFF7FF', '#FFE5B4', '#FFF0D6', '#E6E6FA', '#D8BFD8', '#CDAACD', '#98FB98', '#90EE90', '#70CC70', '#4D994D']
    : ['transparent', '#FFCC99', '#FFB07C', '#E6E6FA', '#D8BFD8', '#B0A0C0', '#8B7BA0', '#66CDAA', '#55AA88', '#3B7A5C', '#20402E'],

  volt: isLightMode
    ? ['transparent', '#FFFFCC', '#FFFF66', '#FFFACD', '#FFD700', '#FFC300', '#FF8C00', '#FF7F00', '#CC6600', '#993D00', '#662600']
    : ['transparent', '#FFFFCC', '#FFFF66', '#FFFACD', '#FFD700', '#FFC300', '#FF8C00', '#FF7F00', '#CC6600', '#993D00', '#662600'],

  retro: isLightMode
    ? ['transparent', '#FFD1E8', '#FF69B4', '#FF1493', '#8B008B', '#800080', '#660066', '#00CED1', '#20B2AA', '#008B8B', '#005555']
    : ['transparent', '#FFD1E8', '#FF69B4', '#FF1493', '#8B008B', '#800080', '#660066', '#00CED1', '#20B2AA', '#008B8B', '#005555'],

  lunar: isLightMode
    ? ['transparent', '#FFFFFF', '#F8F8FF', '#E6E6FA', '#D3D3F0', '#C0C0C0', '#B0C4DE', '#B0B0C0', '#9090A0', '#707080']
    : ['transparent', '#C0C0C0', '#B0C4DE', '#90A0A0', '#708090', '#556B6B', '#404040', '#2F4F4F', '#1E2E2E', '#0F1717'],

  binary: isLightMode
    ? ['transparent', '#FFFFFF', '#D3D3D3', '#AAAAAA', '#708090', '#5A6B7D', '#444444', '#32CD32', '#228B22', '#116611', '#003300']
    : ['transparent', '#AAFFAA', '#66FF66', '#33FF33', '#00FF00', '#00CC00', '#008000', '#005500', '#003300', '#001A00', '#000000'],

  earthy: isLightMode
    ? ['transparent', '#F5E0C0', '#DEB887', '#CD853F', '#B87333', '#A0522D', '#8B5A2B', '#7F5217', '#6B8E23', '#556B2F', '#4F6228']
    : ['transparent', '#D2B48C', '#A67B5B', '#8B4513', '#7C3600', '#654321', '#4B2E1F', '#32CD32', '#228B22', '#1F4D1F', '#0D260D'],

  halloweenAutumn: isLightMode
    ? ['transparent', '#FFD699', '#FFB347', '#FF7518', '#FF8C00', '#FFD700', '#A0522D', '#6B4226', '#8B0000', '#800080', '#2C2C2C']
    : ['transparent', '#FFB347', '#FF8C00', '#FF7518', '#CC7722', '#B22222', '#8B4513', '#3E2723', '#191970', '#4B0082', '#000000'],

  harvestAutumn: isLightMode
    ? ['transparent', '#FFE6B3', '#FFB733', '#FFA500', '#FFD700', '#DAA520', '#CD853F', '#A0522D', '#8B4513', '#6B4226', '#5C3317']
    : ['transparent', '#FFCC00', '#FF8C00', '#E97451', '#D2691E', '#B22222', '#8B4513', '#7C3600', '#654321', '#5C3317', '#2E1A0F'],

  neoTokyo: isLightMode
    ? ['transparent', '#FFCCE0', '#FF69B4', '#FF0055', '#BA55D3', '#9370DB', '#5D00FF', '#40E0D0', '#00BCD4', '#FFD700', '#EEEEEE']
    : ['transparent', '#FFCCE0', '#FF1493', '#FF0055', '#BA55D3', '#8A2BE2', '#5D00FF', '#20B2AA', '#00FFE0', '#FFCC00', '#222222'],

  dreamcore: isLightMode
    ? ['transparent', '#FEF6E4', '#FFEBd6', '#FCD5CE', '#FFC8DD', '#CDB4DB', '#A2D2FF', '#BDE0FE', '#E2ECE9', '#D8E2DC', '#A8B0B0']
    : ['transparent', '#A88C70', '#B08080', '#A07090', '#8A6FA3', '#6FAAC2', '#5A8BB0', '#7A8F88', '#909090', '#2C2C2C', '#141414'],

  medievalFantasy: isLightMode
  ? ['transparent', '#2B0A0A', '#5C0D1A', '#8B1C3C', '#6B1B5F', '#8A2BE2', '#BFA77F', '#D4AF37', '#A9A9A9', '#EDEDED', '#FFFFFF']
  : ['transparent', '#2B0A0A', '#5C0D1A', '#8B1C3C', '#6B1B5F', '#8A2BE2', '#BFA77F', '#D4AF37', '#A9A9A9', '#EDEDED', '#FFFFFF'],
};

// ----------------------------
// State
// ----------------------------
let colors = palettes.default;
let array = [];
let canvasWidth = 16;
let canvasHeight = 16;
let selectedColor = 0;
let undoStack = [];
let redoStack = [];
let allSprites = [];
let currentSpriteIndex = 0;

const canvas = document.getElementById('canvas');
const paletteSelector = document.getElementById('paletteSelector');
const spriteSelector = document.getElementById('spriteSelector');
let isPainting = false;

// ----------------------------
// Populate Theme Selector
// ----------------------------
for(let theme in palettes){
  const opt = document.createElement('option');
  opt.value = theme;
  opt.textContent = theme;
  paletteSelector.appendChild(opt);
}
paletteSelector.value='default';

// ----------------------------
// Functions
// ----------------------------
function renderSwatches(){
  const swatchesDiv = document.getElementById('swatches');
  swatchesDiv.innerHTML='';
  colors.forEach((color,index)=>{
    const swatch = document.createElement('div');
    swatch.className='swatch';
    if(index===selectedColor) swatch.classList.add('selected');
    swatch.style.background=color;
    swatch.addEventListener('click',()=>{ selectedColor=index; renderSwatches(); });
    swatchesDiv.appendChild(swatch);
  });
}

function saveState(){
  undoStack.push(array.map(r=>r.slice()));
  if(undoStack.length>50) undoStack.shift();
  redoStack=[];
}

function paintCell(cell){
  saveState();
  const x=parseInt(cell.dataset.x);
  const y=parseInt(cell.dataset.y);
  array[y][x]=selectedColor;
  cell.dataset.value=selectedColor;
  cell.style.background=colors[selectedColor];
}

function renderCanvas(){
  canvas.innerHTML='';
  const cellSize=Math.floor(Math.min(480, window.innerWidth-20)/Math.max(canvasWidth,canvasHeight));
  canvas.style.gridTemplateColumns=`repeat(${canvasWidth},${cellSize}px)`;
  canvas.style.gridTemplateRows=`repeat(${canvasHeight},${cellSize}px)`;

  for(let y=0;y<canvasHeight;y++){
    for(let x=0;x<canvasWidth;x++){
      const cell=document.createElement('div');
      cell.className='cell';
      cell.dataset.x=x;
      cell.dataset.y=y;
      cell.dataset.value=array[y][x];
      cell.style.width=`${cellSize}px`;
      cell.style.height=`${cellSize}px`;
      cell.style.background=colors[array[y][x]];

      cell.addEventListener('mousedown',()=>{ isPainting=true; paintCell(cell); });
      cell.addEventListener('mouseenter',()=>{ if(isPainting) paintCell(cell); });
      cell.addEventListener('mouseup',()=>{ isPainting=false; });

      cell.addEventListener('touchstart',(e)=>{ paintCell(cell); e.preventDefault(); });
      cell.addEventListener('touchmove',(e)=>{
        const t=e.touches[0];
        const target=document.elementFromPoint(t.clientX,t.clientY);
        if(target && target.classList.contains('cell')) paintCell(target);
        e.preventDefault();
      });

      canvas.appendChild(cell);
    }
  }
  renderSwatches();
  document.body.addEventListener('mouseup',()=>isPainting=false);
}

function updateCanvasColors(){
  document.querySelectorAll('.cell').forEach(cell=>{
    cell.style.background=colors[parseInt(cell.dataset.value)];
  });
}

// ----------------------------
// Sprite functions
// ----------------------------
function loadSprite(index){
  if(!allSprites[index]) return;
  array = allSprites[index].map(r=>r.slice());
  canvasHeight = array.length;
  canvasWidth = array[0].length;
  undoStack=[];
  redoStack=[];
  renderCanvas();
  currentSpriteIndex=index;
}

function addNewSprite(){
  const newSprite = Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  allSprites.push(newSprite);
  const opt = document.createElement('option');
  opt.value = allSprites.length-1;
  opt.textContent = `Sprite ${allSprites.length}`;
  spriteSelector.appendChild(opt);
  spriteSelector.value = allSprites.length-1;
  loadSprite(allSprites.length-1);
}

// ----------------------------
// Init
// ----------------------------
function initCanvas(width=16,height=16){
  canvasWidth=width;
  canvasHeight=height;
  array = Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  allSprites = [array.map(r=>r.slice())];
  spriteSelector.innerHTML='<option value="0">Sprite 1</option>';
  currentSpriteIndex = 0;
  renderCanvas();
}
initCanvas();

// ----------------------------
// Event Listeners
// ----------------------------
paletteSelector.addEventListener('change',()=>{
  colors = palettes[paletteSelector.value];
  selectedColor = 0;
  renderSwatches();
  updateCanvasColors();
});

spriteSelector.addEventListener('change',()=>{
  loadSprite(parseInt(spriteSelector.value));
});

document.getElementById('newSprite').addEventListener('click',addNewSprite);

document.getElementById('undo').addEventListener('click',()=>{
  if(undoStack.length){
    redoStack.push(array.map(r=>r.slice()));
    array = undoStack.pop().map(r=>r.slice());
    renderCanvas();
  }
});
document.getElementById('redo').addEventListener('click',()=>{
  if(redoStack.length){
    undoStack.push(array.map(r=>r.slice()));
    array = redoStack.pop().map(r=>r.slice());
    renderCanvas();
  }
});
document.getElementById('clear').addEventListener('click',()=>{
  saveState();
  array=Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  renderCanvas();
});

// Export
document.getElementById('export').addEventListener('click',()=>{
  allSprites[currentSpriteIndex] = array.map(r=>r.slice());
  document.getElementById('output').textContent=JSON.stringify(allSprites,null,4);
});

// Import
document.getElementById('importFile').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            let importedData = JSON.parse(evt.target.result);

            // Convert object-of-sprites to array-of-sprites
            if (!Array.isArray(importedData) && typeof importedData === 'object') {
                importedData = Object.values(importedData);
            }

            allSprites = importedData.map(spr => {
                if (Array.isArray(spr[0])) {
                    // Already 2D array
                    return spr.map(r => r.slice());
                }
                // Flattened array: attempt to detect rectangle dimensions
                let total = spr.length;
                const possibleSizes = [];
                for (let h = 1; h <= total; h++) {
                    if (total % h === 0) possibleSizes.push([total / h, h]);
                }
                if (possibleSizes.length > 0) {
                    const [w, h] = possibleSizes[0];
                    const grid = [];
                    for (let y = 0; y < h; y++) {
                        grid.push(spr.slice(y * w, (y + 1) * w));
                    }
                    return grid;
                }
                throw 'Cannot auto-detect sprite dimensions';
            });

            loadSprite(0);

            // Populate sprite dropdown
            spriteSelector.innerHTML = '';
            allSprites.forEach((_, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `Sprite ${i + 1}`;
                spriteSelector.appendChild(opt);
            });
            spriteSelector.value = 0;

        } catch (err) {
            alert('Invalid JSON file: ' + err);
        }
    };
    reader.readAsText(file);
});

</script>

</body>
</html>
