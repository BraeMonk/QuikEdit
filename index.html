<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pixel Sprite Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: sans-serif; padding: 10px; text-align: center; background: #1c1c1c; color: #fff; }
  #controls { margin-bottom: 10px; }
  #canvas { display: grid; touch-action: none; margin: 10px auto; border: 1px solid #555; }
  .cell { border: 1px solid #333; box-sizing: border-box; }
  button, select, input { margin: 5px; padding: 8px 16px; font-size: 14px; cursor: pointer; }
  #swatches { margin-top: 10px; }
  .swatch { display: inline-block; width: 30px; height: 30px; margin: 2px; border: 1px solid #333; cursor: pointer; }
  .swatch.selected { border: 3px solid #fff; }
  pre { text-align: left; max-width: 100%; overflow-x: auto; background: #222; padding: 10px; color: #fff; }
</style>
</head>
<body>

<h2>Pixel Sprite Editor</h2>

<div id="controls">
  Theme:
  <select id="paletteSelector"></select>

  Sprite:
  <select id="spriteSelector"></select>
  <button id="newSprite">New Sprite</button>

  <button id="undo">Undo</button>
  <button id="redo">Redo</button>
  <button id="clear">Clear</button>
  <button id="export">Export Array</button>
  <input type="file" id="importFile" accept=".json">
</div>

<div id="swatches"></div>
<div id="canvas"></div>
<pre id="output"></pre>

<script>
// ----------------------------
// Light/Dark mode toggle
// ----------------------------
const isLightMode = true; // change to false for dark variants

// ----------------------------
// Inline themes (arrays now)
// ----------------------------
const palettes = {
  default: isLightMode 
    ? [0, 'transparent', 1, '#FFF2E0', 2, '#FFE0B3', 3, '#FFD8A6', 4, '#FFCB88', 5, '#E6B273', 6, '#C4945E', 7, '#A9745B', 8, '#8B5E3C', 9, '#6B4226', 10, '#4A2B17']
    : [0, 'transparent', 1, '#E0ECFA', 2, '#C2DAF7', 3, '#9CC7F0', 4, '#6FA6E0', 5, '#4A90E2', 6, '#2B6FB2', 7, '#1F5FBF', 8, '#173F80', 9, '#0D264D', 10, '#08162B'],

  chaotic: isLightMode
    ? [0, 'transparent', 1, '#FFE5E0', 2, '#FFB3A1', 3, '#FF7F66', 4, '#FF6347', 5, '#FF4500', 6, '#E63E00', 7, '#B22222', 8, '#8B0000', 9, '#660000', 10, '#330000']
    : [0, 'transparent', 1, '#FFB3A1', 2, '#FF7F66', 3, '#FF6347', 4, '#FF4500', 5, '#E63E00', 6, '#B22222', 7, '#8B0000', 8, '#660000', 9, '#330000', 10, '#1A0000'],

  neutral: isLightMode
    ? [0, 'transparent', 1, '#F8F0FF', 2, '#E0CFFF', 3, '#D8BFFF', 4, '#B58ED9', 5, '#9C6AC7', 6, '#7D3C98', 7, '#6A0DAD', 8, '#4B0082', 9, '#3A0066', 10, '#250044']
    : [0, 'transparent', 1, '#E0CFFF', 2, '#D8BFFF', 3, '#B58ED9', 4, '#9C6AC7', 5, '#7D3C98', 6, '#6A0DAD', 7, '#4B0082', 8, '#330055', 9, '#1E0033', 10, '#0F001A'],

  noir: isLightMode
    ? [0, 'transparent', 1, '#FFFFFF', 2, '#DDDDDD', 3, '#BBBBBB', 4, '#999999', 5, '#777777', 6, '#555555', 7, '#333333', 8, '#111111', 9, '#000000']
    : [0, 'transparent', 1, '#FFFFFF', 2, '#DDDDDD', 3, '#BBBBBB', 4, '#999999', 5, '#777777', 6, '#555555', 7, '#333333', 8, '#111111', 9, '#000000'],

  forest: isLightMode
    ? [0, 'transparent', 1, '#E5F7EC', 2, '#C3EED3', 3, '#A9DFBF', 4, '#82E0AA', 5, '#58C48F', 6, '#2E8B57', 7, '#1B5E20', 8, '#145C17', 9, '#0C3B0F', 10, '#061F08']
    : [0, 'transparent', 1, '#C3EED3', 2, '#A9DFBF', 3, '#82E0AA', 4, '#58C48F', 5, '#2E8B57', 6, '#1B5E20', 7, '#145C17', 8, '#0C3B0F', 9, '#061F08', 10, '#020C04'],

  neon: isLightMode
    ? [0, 'transparent', 1, '#FFB3FF', 2, '#FF66FF', 3, '#FF00FF', 4, '#CC00CC', 5, '#990099', 6, '#660066', 7, '#33FFFF', 8, '#00FFFF', 9, '#00CCCC', 10, '#009999']
    : [0, 'transparent', 1, '#B3FFFF', 2, '#66FFFF', 3, '#00FFFF', 4, '#33CCCC', 5, '#00CCCC', 6, '#009999', 7, '#FF66FF', 8, '#FF00FF', 9, '#CC00CC', 10, '#990099'],

  solar: isLightMode
    ? [0, 'transparent', 1, '#FFF5CC', 2, '#FFE6A3', 3, '#FFD580', 4, '#FFCB66', 5, '#FF8C00', 6, '#E67E22', 7, '#CC7000', 8, '#B35900', 9, '#803D00', 10, '#4D2400']
    : [0, 'transparent', 1, '#FFE6A3', 2, '#FFD580', 3, '#FFCB66', 4, '#FF8C00', 5, '#E67E22', 6, '#CC7000', 7, '#B35900', 8, '#803D00', 9, '#4D2400', 10, '#261200'],

  glacial: isLightMode
    ? [0, 'transparent', 1, '#F0FAFF', 2, '#D6EAF8', 3, '#B3E5FC', 4, '#A9DDF2', 5, '#85C1E9', 6, '#5DADE2', 7, '#2E86C1', 8, '#154360', 9, '#0E2B3F', 10, '#061522']
    : [0, 'transparent', 1, '#EBF5FB', 2, '#D6EAF8', 3, '#B3E5FC', 4, '#AED6F1', 5, '#85C1E9', 6, '#5DADE2', 7, '#2E86C1', 8, '#154360', 9, '#0E2B3F', 10, '#061522'],

  cosmic: isLightMode
    ? [0, 'transparent', 1, '#F0E6FF', 2, '#E0B0FF', 3, '#D8A0FF', 4, '#B47CD9', 5, '#8A2BE2', 6, '#5C1F80', 7, '#2C003E', 8, '#1A0010', 9, '#12001A', 10, '#0A000C']
    : [0, 'transparent', 1, '#E0B0FF', 2, '#D8A0FF', 3, '#B47CD9', 4, '#8A2BE2', 5, '#5C1F80', 6, '#2C003E', 7, '#1A0010', 8, '#12001A', 9, '#0A000C'],

  blossom: isLightMode
    ? [0, 'transparent', 1, '#FFF7FF', 2, '#FFE5B4', 3, '#FFF0D6', 4, '#E6E6FA', 5, '#D8BFD8', 6, '#CDAACD', 7, '#98FB98', 8, '#90EE90', 9, '#70CC70', 10, '#4D994D']
    : [0, 'transparent', 1, '#FFCC99', 2, '#FFB07C', 3, '#E6E6FA', 4, '#D8BFD8', 5, '#B0A0C0', 6, '#8B7BA0', 7, '#66CDAA', 8, '#55AA88', 9, '#3B7A5C', 10, '#20402E'],

  volt: isLightMode
    ? [0, 'transparent', 1, '#FFFFCC', 2, '#FFFF66', 3, '#FFFACD', 4, '#FFD700', 5, '#FFC300', 6, '#FF8C00', 7, '#FF7F00', 8, '#CC6600', 9, '#993D00', 10, '#662600']
    : [0, 'transparent', 1, '#FFFFCC', 2, '#FFFF66', 3, '#FFFACD', 4, '#FFD700', 5, '#FFC300', 6, '#FF8C00', 7, '#FF7F00', 8, '#CC6600', 9, '#993D00', 10, '#662600'],

  retro: isLightMode
    ? [0, 'transparent', 1, '#FFD1E8', 2, '#FF69B4', 3, '#FF1493', 4, '#8B008B', 5, '#800080', 6, '#660066', 7, '#00CED1', 8, '#20B2AA', 9, '#008B8B', 10, '#005555']
    : [0, 'transparent', 1, '#FFD1E8', 2, '#FF69B4', 3, '#FF1493', 4, '#8B008B', 5, '#800080', 6, '#660066', 7, '#00CED1', 8, '#20B2AA', 9, '#008B8B', 10, '#005555'],

  lunar: isLightMode
    ? [0, 'transparent', 1, '#FFFFFF', 2, '#F8F8FF', 3, '#E6E6FA', 4, '#D3D3F0', 5, '#C0C0C0', 6, '#B0C4DE', 7, '#B0B0C0', 8, '#9090A0', 9, '#707080']
    : [0, 'transparent', 1, '#C0C0C0', 2, '#B0C4DE', 3, '#90A0A0', 4, '#708090', 5, '#556B6B', 6, '#404040', 7, '#2F4F4F', 8, '#1E2E2E', 9, '#0F1717'],

  binary: isLightMode
    ? [0, 'transparent', 1, '#FFFFFF', 2, '#D3D3D3', 3, '#AAAAAA', 4, '#708090', 5, '#5A6B7D', 6, '#444444', 7, '#32CD32', 8, '#228B22', 9, '#116611', 10, '#003300']
    : [0, 'transparent', 1, '#AAFFAA', 2, '#66FF66', 3, '#33FF33', 4, '#00FF00', 5, '#00CC00', 6, '#008000', 7, '#005500', 8, '#003300', 9, '#001A00', 10, '#000000'],

  earthy: isLightMode
    ? [0, 'transparent', 1, '#F5E0C0', 2, '#DEB887', 3, '#CD853F', 4, '#B87333', 5, '#A0522D', 6, '#8B5A2B', 7, '#7F5217', 8, '#6B8E23', 9, '#556B2F', 10, '#4F6228']
    : [0, 'transparent', 1, '#D2B48C', 2, '#A67B5B', 3, '#8B4513', 4, '#7C3600', 5, '#654321', 6, '#4B2E1F', 7, '#32CD32', 8, '#228B22', 9, '#1F4D1F', 10, '#0D260D'],

  halloweenAutumn: isLightMode
    ? [0, 'transparent', 1, '#FFD699', 2, '#FFB347', 3, '#FF7518', 4, '#FF8C00', 5, '#FFD700', 6, '#A0522D', 7, '#6B4226', 8, '#8B0000', 9, '#800080', 10, '#2C2C2C']
    : [0, 'transparent', 1, '#FFB347', 2, '#FF8C00', 3, '#FF7518', 4, '#CC7722', 5, '#B22222', 6, '#8B4513', 7, '#3E2723', 8, '#191970', 9, '#4B0082', 10, '#000000'],

  harvestAutumn: isLightMode
    ? [0, 'transparent', 1, '#FFE6B3', 2, '#FFB733', 3, '#FFA500', 4, '#FFD700', 5, '#DAA520', 6, '#CD853F', 7, '#A0522D', 8, '#8B4513', 9, '#6B4226', 10, '#5C3317']
    : [0, 'transparent', 1, '#FFCC00', 2, '#FF8C00', 3, '#E97451', 4, '#D2691E', 5, '#B22222', 6, '#8B4513', 7, '#7C3600', 8, '#654321', 9, '#5C3317', 10, '#2E1A0F'],

  neoTokyo: isLightMode
    ? [0, 'transparent', 1, '#FFCCE0', 2, '#FF69B4', 3, '#FF0055', 4, '#BA55D3', 5, '#9370DB', 6, '#5D00FF', 7, '#40E0D0', 8, '#00BCD4', 9, '#FFD700', 10, '#EEEEEE']
    : [0, 'transparent', 1, '#FFCCE0', 2, '#FF1493', 3, '#FF0055', 4, '#BA55D3', 5, '#8A2BE2', 6, '#5D00FF', 7, '#20B2AA', 8, '#00FFE0', 9, '#FFCC00', 10, '#222222'],

  dreamcore: isLightMode
    ? [0, 'transparent', 1, '#FEF6E4', 2, '#FFEBd6', 3, '#FCD5CE', 4, '#FFC8DD', 5, '#CDB4DB', 6, '#A2D2FF', 7, '#BDE0FE', 8, '#E2ECE9', 9, '#D8E2DC', 10, '#A8B0B0']
    : [0, 'transparent', 1, '#A88C70', 2, '#B08080', 3, '#A07090', 4, '#8A6FA3', 5, '#6FAAC2', 6, '#5A8BB0', 7, '#7A8F88', 8, '#909090', 9, '#2C2C2C', 10, '#141414'],

  medievalFantasy: isLightMode
    ? [0, 'transparent', 1, '#F5F0E1', 2, '#DEB887', 3, '#D2B48C', 4, '#C0A080', 5, '#BFA77F', 6, '#A0522D', 7, '#8B5A2B', 8, '#7F684E', 9, '#6B4226', 10, '#3B2617']
    : [0, 'transparent', 1, '#C0A080', 2, '#A0522D', 3, '#8B5A2B', 4, '#7F684E', 5, '#6B4226', 6, '#5C3317', 7, '#4B2E1F', 8, '#362312', 9, '#2A1A0F', 10, '#1A0D07'];
};

// ----------------------------
// State
// ----------------------------
let colors = palettes.default;
let array = [];
let canvasWidth = 16;
let canvasHeight = 16;
let selectedColor = 0;
let undoStack = [];
let redoStack = [];
let allSprites = [];
let currentSpriteIndex = 0;

const canvas = document.getElementById('canvas');
const paletteSelector = document.getElementById('paletteSelector');
const spriteSelector = document.getElementById('spriteSelector');
let isPainting = false;

// ----------------------------
// Populate Theme Selector
// ----------------------------
for(let theme in palettes){
  const opt = document.createElement('option');
  opt.value = theme;
  opt.textContent = theme;
  paletteSelector.appendChild(opt);
}
paletteSelector.value='default';

// ----------------------------
// Functions
// ----------------------------
function renderSwatches(){
  const swatchesDiv = document.getElementById('swatches');
  swatchesDiv.innerHTML='';
  colors.forEach((color,index)=>{
    const swatch = document.createElement('div');
    swatch.className='swatch';
    if(index===selectedColor) swatch.classList.add('selected');
    swatch.style.background=color;
    swatch.addEventListener('click',()=>{ selectedColor=index; renderSwatches(); });
    swatchesDiv.appendChild(swatch);
  });
}

function saveState(){
  undoStack.push(array.map(r=>r.slice()));
  if(undoStack.length>50) undoStack.shift();
  redoStack=[];
}

function paintCell(cell){
  saveState();
  const x=parseInt(cell.dataset.x);
  const y=parseInt(cell.dataset.y);
  array[y][x]=selectedColor;
  cell.dataset.value=selectedColor;
  cell.style.background=colors[selectedColor];
}

function renderCanvas(){
  canvas.innerHTML='';
  const cellSize=Math.floor(Math.min(480, window.innerWidth-20)/Math.max(canvasWidth,canvasHeight));
  canvas.style.gridTemplateColumns=`repeat(${canvasWidth},${cellSize}px)`;
  canvas.style.gridTemplateRows=`repeat(${canvasHeight},${cellSize}px)`;

  for(let y=0;y<canvasHeight;y++){
    for(let x=0;x<canvasWidth;x++){
      const cell=document.createElement('div');
      cell.className='cell';
      cell.dataset.x=x;
      cell.dataset.y=y;
      cell.dataset.value=array[y][x];
      cell.style.width=`${cellSize}px`;
      cell.style.height=`${cellSize}px`;
      cell.style.background=colors[array[y][x]];

      cell.addEventListener('mousedown',()=>{ isPainting=true; paintCell(cell); });
      cell.addEventListener('mouseenter',()=>{ if(isPainting) paintCell(cell); });
      cell.addEventListener('mouseup',()=>{ isPainting=false; });

      cell.addEventListener('touchstart',(e)=>{ paintCell(cell); e.preventDefault(); });
      cell.addEventListener('touchmove',(e)=>{
        const t=e.touches[0];
        const target=document.elementFromPoint(t.clientX,t.clientY);
        if(target && target.classList.contains('cell')) paintCell(target);
        e.preventDefault();
      });

      canvas.appendChild(cell);
    }
  }
  renderSwatches();
  document.body.addEventListener('mouseup',()=>isPainting=false);
}

function updateCanvasColors(){
  document.querySelectorAll('.cell').forEach(cell=>{
    cell.style.background=colors[parseInt(cell.dataset.value)];
  });
}

// ----------------------------
// Sprite functions
// ----------------------------
function loadSprite(index){
  if(!allSprites[index]) return;
  array = allSprites[index].map(r=>r.slice());
  canvasHeight = array.length;
  canvasWidth = array[0].length;
  undoStack=[];
  redoStack=[];
  renderCanvas();
  currentSpriteIndex=index;
}

function addNewSprite(){
  const newSprite = Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  allSprites.push(newSprite);
  const opt = document.createElement('option');
  opt.value = allSprites.length-1;
  opt.textContent = `Sprite ${allSprites.length}`;
  spriteSelector.appendChild(opt);
  spriteSelector.value = allSprites.length-1;
  loadSprite(allSprites.length-1);
}

// ----------------------------
// Init
// ----------------------------
function initCanvas(width=16,height=16){
  canvasWidth=width;
  canvasHeight=height;
  array = Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  allSprites = [array.map(r=>r.slice())];
  spriteSelector.innerHTML='<option value="0">Sprite 1</option>';
  currentSpriteIndex = 0;
  renderCanvas();
}
initCanvas();

// ----------------------------
// Event Listeners
// ----------------------------
paletteSelector.addEventListener('change',()=>{
  colors = palettes[paletteSelector.value];
  selectedColor = 0;
  renderSwatches();
  updateCanvasColors();
});

spriteSelector.addEventListener('change',()=>{
  loadSprite(parseInt(spriteSelector.value));
});

document.getElementById('newSprite').addEventListener('click',addNewSprite);

document.getElementById('undo').addEventListener('click',()=>{
  if(undoStack.length){
    redoStack.push(array.map(r=>r.slice()));
    array = undoStack.pop().map(r=>r.slice());
    renderCanvas();
  }
});
document.getElementById('redo').addEventListener('click',()=>{
  if(redoStack.length){
    undoStack.push(array.map(r=>r.slice()));
    array = redoStack.pop().map(r=>r.slice());
    renderCanvas();
  }
});
document.getElementById('clear').addEventListener('click',()=>{
  saveState();
  array=Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  renderCanvas();
});

// Export
document.getElementById('export').addEventListener('click',()=>{
  allSprites[currentSpriteIndex] = array.map(r=>r.slice());
  document.getElementById('output').textContent=JSON.stringify(allSprites,null,4);
});

// Import
document.getElementById('importFile').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt) {
        try {
            let importedData = JSON.parse(evt.target.result);

            // Convert object-of-sprites to array-of-sprites
            if (!Array.isArray(importedData) && typeof importedData === 'object') {
                importedData = Object.values(importedData);
            }

            allSprites = importedData.map(spr => {
                if (Array.isArray(spr[0])) {
                    // Already 2D array
                    return spr.map(r => r.slice());
                }
                // Flattened array: attempt to detect rectangle dimensions
                let total = spr.length;
                const possibleSizes = [];
                for (let h = 1; h <= total; h++) {
                    if (total % h === 0) possibleSizes.push([total / h, h]);
                }
                if (possibleSizes.length > 0) {
                    const [w, h] = possibleSizes[0];
                    const grid = [];
                    for (let y = 0; y < h; y++) {
                        grid.push(spr.slice(y * w, (y + 1) * w));
                    }
                    return grid;
                }
                throw 'Cannot auto-detect sprite dimensions';
            });

            loadSprite(0);

            // Populate sprite dropdown
            spriteSelector.innerHTML = '';
            allSprites.forEach((_, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = `Sprite ${i + 1}`;
                spriteSelector.appendChild(opt);
            });
            spriteSelector.value = 0;

        } catch (err) {
            alert('Invalid JSON file: ' + err);
        }
    };
    reader.readAsText(file);
});

</script>

</body>
</html>
