<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pixel Sprite Editor</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: sans-serif; padding: 10px; text-align: center; background: #1c1c1c; color: #fff; }
  #controls { margin-bottom: 10px; }
  #canvas { display: grid; touch-action: none; margin: 10px auto; border: 1px solid #555; }
  .cell { border: 1px solid #333; box-sizing: border-box; }
  button, select, input { margin: 5px; padding: 8px 16px; font-size: 14px; cursor: pointer; }
  #swatches { margin-top: 10px; }
  .swatch { display: inline-block; width: 30px; height: 30px; margin: 2px; border: 1px solid #333; cursor: pointer; }
  .swatch.selected { border: 3px solid #fff; }
  pre { text-align: left; max-width: 100%; overflow-x: auto; background: #222; padding: 10px; color: #fff; }
</style>
</head>
<body>

<h2>Pixel Sprite Editor</h2>

<div id="controls">
  Theme:
  <select id="paletteSelector"></select>

  Sprite:
  <select id="spriteSelector"></select>
  <button id="newSprite">New Sprite</button>

  <button id="undo">Undo</button>
  <button id="redo">Redo</button>
  <button id="clear">Clear</button>
  <button id="export">Export Array</button>
  <input type="file" id="importFile" accept=".json">
</div>

<div id="swatches"></div>
<div id="canvas"></div>
<pre id="output"></pre>

<script>
// ----------------------------
// Light/Dark mode toggle
// ----------------------------
const isLightMode = true; // change to false for dark variants

// ----------------------------
// Inline themes
// ----------------------------
const palettes = {
  default: isLightMode
    ? { 0: 'transparent', 1: '#8B5E3C', 2: '#FFD8A6', 3: '#5C3A25', 4: '#FFCB88', 5: '#8B5E3C', 6: '#FFD8A6', 7: '#A9745B', 8: '#FFE0B3', 9: '#6B4226' }
    : { 0: 'transparent', 1: '#4a90e2', 2: '#ffffff', 3: '#1f5fbf', 4: '#9cc7f0', 5: '#4a90e2', 6: '#ffffff', 7: '#2b6fb2', 8: '#cce6ff', 9: '#173f80' },
  chaotic: isLightMode
    ? { 0: 'transparent', 1: '#8B0000', 2: '#FF4500', 3: '#4B0000', 4: '#FF6347', 5: '#8B0000', 6: '#FF4500', 7: '#B22222', 8: '#FF7F50', 9: '#6B0000' }
    : { 0: 'transparent', 1: '#FF4500', 2: '#8B0000', 3: '#FF6347', 4: '#4B0000', 5: '#FF4500', 6: '#8B0000', 7: '#FF7F50', 8: '#B22222', 9: '#660000' },
  neutral: isLightMode
    ? { 0: 'transparent', 1: '#6A0DAD', 2: '#E0CFFF', 3: '#4B0082', 4: '#D8BFFF', 5: '#6A0DAD', 6: '#E0CFFF', 7: '#7D3C98', 8: '#F0D6FF', 9: '#3A0066' }
    : { 0: 'transparent', 1: '#E0CFFF', 2: '#6A0DAD', 3: '#D8BFFF', 4: '#4B0082', 5: '#E0CFFF', 6: '#6A0DAD', 7: '#F0D6FF', 8: '#7D3C98', 9: '#330055' },
  noir: isLightMode
    ? { 0: 'transparent', 1: '#333333', 2: '#DDDDDD', 3: '#000000', 4: '#FFFFFF', 5: '#333333', 6: '#DDDDDD', 7: '#555555', 8: '#BBBBBB', 9: '#111111' }
    : { 0: 'transparent', 1: '#DDDDDD', 2: '#333333', 3: '#FFFFFF', 4: '#000000', 5: '#DDDDDD', 6: '#333333', 7: '#BBBBBB', 8: '#555555', 9: '#111111' },
  forest: isLightMode
    ? { 0: 'transparent', 1: '#2E8B57', 2: '#A9DFBF', 3: '#1B5E20', 4: '#82E0AA', 5: '#2E8B57', 6: '#A9DFBF', 7: '#1A4720', 8: '#74D6A2', 9: '#145C17' }
    : { 0: 'transparent', 1: '#A9DFBF', 2: '#2E8B57', 3: '#82E0AA', 4: '#1B5E20', 5: '#A9DFBF', 6: '#2E8B57', 7: '#74D6A2', 8: '#145C17', 9: '#1A4720' },
  neon: isLightMode
    ? { 0: 'transparent', 1: '#FF00FF', 2: '#00FFFF', 3: '#990099', 4: '#66FFFF', 5: '#FF00FF', 6: '#00FFFF', 7: '#CC00CC', 8: '#33FFFF', 9: '#660066' }
    : { 0: 'transparent', 1: '#00FFFF', 2: '#FF00FF', 3: '#66FFFF', 4: '#990099', 5: '#00FFFF', 6: '#FF00FF', 7: '#33FFFF', 8: '#CC00CC', 9: '#660066' },
  solar: isLightMode
    ? { 0: 'transparent', 1: '#FF8C00', 2: '#FFF5CC', 3: '#CC7000', 4: '#FFD580', 5: '#FF8C00', 6: '#FFF5CC', 7: '#E67E22', 8: '#FFE6A3', 9: '#B35900' }
    : { 0: 'transparent', 1: '#FFD580', 2: '#FF8C00', 3: '#FFF5CC', 4: '#CC7000', 5: '#FFD580', 6: '#FF8C00', 7: '#FFE6A3', 8: '#E67E22', 9: '#B35900' },
  glacial: isLightMode
    ? { 0: 'transparent', 1: '#F0FAFF', 2: '#D6EAF8', 3: '#A9DDF2', 4: '#85C1E9', 5: '#B3E5FC', 6: '#AED6F1', 7: '#5DADE2', 8: '#2E86C1', 9: '#154360' }
    : { 0: 'transparent', 1: '#EBF5FB', 2: '#AED6F1', 3: '#5DADE2', 4: '#D6EAF8', 5: '#A9DDF2', 6: '#EBF5FB', 7: '#AED6F1', 8: '#5DADE2', 9: '#154360' },
  cosmic: isLightMode
    ? { 0: 'transparent', 1: '#2C003E', 2: '#E0B0FF', 3: '#12001A', 4: '#8A2BE2', 5: '#2C003E', 6: '#E0B0FF', 7: '#5C1F80', 8: '#D8A0FF', 9: '#1A0010' }
    : { 0: 'transparent', 1: '#8A2BE2', 2: '#E0B0FF', 3: '#2C003E', 4: '#12001A', 5: '#8A2BE2', 6: '#E0B0FF', 7: '#5C1F80', 8: '#D8A0FF', 9: '#1A0010' },
  blossom: isLightMode
    ? { 0: 'transparent', 1: '#E6E6FA', 2: '#FFE5B4', 3: '#98FB98', 4: '#FFFFFF', 5: '#E6E6FA', 6: '#FFE5B4', 7: '#D8BFD8', 8: '#FFF0D6', 9: '#90EE90' }
    : { 0: 'transparent', 1: '#D8BFD8', 2: '#FFB07C', 3: '#66CDAA', 4: '#E6E6FA', 5: '#D8BFD8', 6: '#FFB07C', 7: '#B0A0C0', 8: '#FFCC99', 9: '#55AA88' },
  volt: isLightMode
    ? { 0: 'transparent', 1: '#FFD700', 2: '#FFFFFF', 3: '#FF8C00', 4: '#FFFF66', 5: '#FFD700', 6: '#FFFFFF', 7: '#FFC300', 8: '#FFFACD', 9: '#FF7F00' }
    : { 0: 'transparent', 1: '#FFFF66', 2: '#FFD700', 3: '#FFFFFF', 4: '#FF8C00', 5: '#FFFF66', 6: '#FFD700', 7: '#FFFACD', 8: '#FFC300', 9: '#FF7F00' },
  retro: isLightMode
    ? { 0: 'transparent', 1: '#FF69B4', 2: '#00CED1', 3: '#8B008B', 4: '#FFD700', 5: '#FF69B4', 6: '#00CED1', 7: '#FF1493', 8: '#20B2AA', 9: '#800080' }
    : { 0: 'transparent', 1: '#00CED1', 2: '#FF69B4', 3: '#FFD700', 4: '#8B008B', 5: '#00CED1', 6: '#FF69B4', 7: '#20B2AA', 8: '#FF1493', 9: '#800080' },
  lunar: isLightMode
    ? { 0: 'transparent', 1: '#F8F8FF', 2: '#C0C0C0', 3: '#B0C4DE', 4: '#E6E6FA', 5: '#F8F8FF', 6: '#C0C0C0', 7: '#D3D3F0', 8: '#E0E0E8', 9: '#B0B0C0' }
    : { 0: 'transparent', 1: '#2F4F4F', 2: '#708090', 3: '#B0C4DE', 4: '#C0C0C0', 5: '#2F4F4F', 6: '#708090', 7: '#556B6B', 8: '#90A0A0', 9: '#404040' },
  binary: isLightMode
    ? { 0: 'transparent', 1: '#708090', 2: '#B22222', 3: '#32CD32', 4: '#D3D3D3', 5: '#708090', 6: '#B22222', 7: '#5A6B7D', 8: '#FF4040', 9: '#228B22' }
    : { 0: 'transparent', 1: '#000000', 2: '#00FF00', 3: '#008000', 4: '#AAFFAA', 5: '#000000', 6: '#00FF00', 7: '#005500', 8: '#33FF33', 9: '#003300' },
  earthy: isLightMode 
    ? { 0: 'transparent', 1: '#8B5A2B', 2: '#A0522D', 3: '#556B2F', 4: '#6B8E23', 5: '#CD853F', 6: '#9ACD32', 7: '#7F5217', 8: '#B87333', 9: '#4F6228' } 
    : { 0: 'transparent', 1: '#654321', 2: '#8B4513', 3: '#228B22', 4: '#32CD32', 5: '#A0522D', 6: '#ADFF2F', 7: '#4B2E1F', 8: '#7C3600', 9: '#1F4D1F' },
  halloweenAutumn: isLightMode 
    ? { 0:'transparent',1:'#FF7518',2:'#FFB347',3:'#8B0000',4:'#6B4226',5:'#FFD700',6:'#A0522D',7:'#2F4F4F',8:'#800080',9:'#2C2C2C' } 
    : { 0:'transparent',1:'#FF4500',2:'#CC7722',3:'#B22222',4:'#3E2723',5:'#FF8C00',6:'#8B4513',7:'#191970',8:'#4B0082',9:'#000000' },
  harvestAutumn: isLightMode 
    ? { 0:'transparent',1:'#FFA500',2:'#FFB733',3:'#FF6347',4:'#CD853F',5:'#FFD700',6:'#F4A460',7:'#8B4513',8:'#DAA520',9:'#A0522D' } 
    : { 0:'transparent',1:'#FF8C00',2:'#E97451',3:'#B22222',4:'#8B4513',5:'#FFCC00',6:'#D2691E',7:'#654321',8:'#B8860B',9:'#5C3317' }
};

// ----------------------------
// State
// ----------------------------
let colors = palettes.default;
let array = [];
let canvasWidth = 16;
let canvasHeight = 16;
let selectedColor = 0;
let undoStack = [];
let redoStack = [];
let allSprites = [];
let currentSpriteIndex = 0;

const canvas = document.getElementById('canvas');
const paletteSelector = document.getElementById('paletteSelector');
const spriteSelector = document.getElementById('spriteSelector');
let isPainting = false;

// ----------------------------
// Populate Theme Selector
// ----------------------------
for(let theme in palettes){
  const opt = document.createElement('option');
  opt.value = theme;
  opt.textContent = theme;
  paletteSelector.appendChild(opt);
}
paletteSelector.value='default';

// ----------------------------
// Functions
// ----------------------------
function renderSwatches(){
  const swatchesDiv = document.getElementById('swatches');
  swatchesDiv.innerHTML='';
  colors.forEach((color,index)=>{
    const swatch = document.createElement('div');
    swatch.className='swatch';
    if(index===selectedColor) swatch.classList.add('selected');
    swatch.style.background=color;
    swatch.addEventListener('click',()=>{ selectedColor=index; renderSwatches(); });
    swatchesDiv.appendChild(swatch);
  });
}

function saveState(){
  undoStack.push(array.map(r=>r.slice()));
  if(undoStack.length>50) undoStack.shift();
  redoStack=[];
}

function paintCell(cell){
  saveState();
  const x=parseInt(cell.dataset.x);
  const y=parseInt(cell.dataset.y);
  array[y][x]=selectedColor;
  cell.dataset.value=selectedColor;
  cell.style.background=colors[selectedColor];
}

function renderCanvas(){
  canvas.innerHTML='';
  const cellSize=Math.floor(Math.min(480, window.innerWidth-20)/Math.max(canvasWidth,canvasHeight));
  canvas.style.gridTemplateColumns=`repeat(${canvasWidth},${cellSize}px)`;
  canvas.style.gridTemplateRows=`repeat(${canvasHeight},${cellSize}px)`;

  for(let y=0;y<canvasHeight;y++){
    for(let x=0;x<canvasWidth;x++){
      const cell=document.createElement('div');
      cell.className='cell';
      cell.dataset.x=x;
      cell.dataset.y=y;
      cell.dataset.value=array[y][x];
      cell.style.width=`${cellSize}px`;
      cell.style.height=`${cellSize}px`;
      cell.style.background=colors[array[y][x]];

      cell.addEventListener('mousedown',()=>{ isPainting=true; paintCell(cell); });
      cell.addEventListener('mouseenter',()=>{ if(isPainting) paintCell(cell); });
      cell.addEventListener('mouseup',()=>{ isPainting=false; });

      cell.addEventListener('touchstart',(e)=>{ paintCell(cell); e.preventDefault(); });
      cell.addEventListener('touchmove',(e)=>{
        const t=e.touches[0];
        const target=document.elementFromPoint(t.clientX,t.clientY);
        if(target && target.classList.contains('cell')) paintCell(target);
        e.preventDefault();
      });

      canvas.appendChild(cell);
    }
  }
  renderSwatches();
  document.body.addEventListener('mouseup',()=>isPainting=false);
}

function updateCanvasColors(){
  document.querySelectorAll('.cell').forEach(cell=>{
    cell.style.background=colors[parseInt(cell.dataset.value)];
  });
}

// ----------------------------
// Sprite functions
// ----------------------------
function loadSprite(index){
  if(!allSprites[index]) return;
  array = allSprites[index].map(r=>r.slice());
  canvasHeight = array.length;
  canvasWidth = array[0].length;
  undoStack=[];
  redoStack=[];
  renderCanvas();
  currentSpriteIndex=index;
}

function addNewSprite(){
  const newSprite = Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  allSprites.push(newSprite);
  const opt = document.createElement('option');
  opt.value = allSprites.length-1;
  opt.textContent = `Sprite ${allSprites.length}`;
  spriteSelector.appendChild(opt);
  spriteSelector.value = allSprites.length-1;
  loadSprite(allSprites.length-1);
}

// ----------------------------
// Init
// ----------------------------
function initCanvas(width=16,height=16){
  canvasWidth=width;
  canvasHeight=height;
  array = Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  allSprites = [array.map(r=>r.slice())];
  spriteSelector.innerHTML='<option value="0">Sprite 1</option>';
  currentSpriteIndex = 0;
  renderCanvas();
}
initCanvas();

// ----------------------------
// Event Listeners
// ----------------------------
paletteSelector.addEventListener('change',()=>{
  colors = palettes[paletteSelector.value];
  selectedColor = 0;
  renderSwatches();
  updateCanvasColors();
});

spriteSelector.addEventListener('change',()=>{
  loadSprite(parseInt(spriteSelector.value));
});

document.getElementById('newSprite').addEventListener('click',addNewSprite);

document.getElementById('undo').addEventListener('click',()=>{
  if(undoStack.length){
    redoStack.push(array.map(r=>r.slice()));
    array = undoStack.pop().map(r=>r.slice());
    renderCanvas();
  }
});
document.getElementById('redo').addEventListener('click',()=>{
  if(redoStack.length){
    undoStack.push(array.map(r=>r.slice()));
    array = redoStack.pop().map(r=>r.slice());
    renderCanvas();
  }
});
document.getElementById('clear').addEventListener('click',()=>{
  saveState();
  array=Array.from({length:canvasHeight},()=>Array(canvasWidth).fill(0));
  renderCanvas();
});

// Export
document.getElementById('export').addEventListener('click',()=>{
  allSprites[currentSpriteIndex] = array.map(r=>r.slice());
  document.getElementById('output').textContent=JSON.stringify(allSprites,null,4);
});

// Import
document.getElementById('importFile').addEventListener('change',e=>{
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload=function(evt){
    try{
      const imported = JSON.parse(evt.target.result);

      // Convert flattened arrays into 2D arrays
      allSprites = imported.map(spr=>{
        if(Array.isArray(spr[0])) return spr.map(r=>r.slice());
        // If flattened, attempt to detect rectangle width/height
        let total = spr.length;
        const possibleSizes = [];
        for(let h=1;h<=total;h++){
          if(total % h === 0) possibleSizes.push([total/h,h]);
        }
        if(possibleSizes.length>0){
          const [w,h] = possibleSizes[0];
          const grid = [];
          for(let y=0;y<h;y++){
            grid.push(spr.slice(y*w,(y+1)*w));
          }
          return grid;
        }
        throw 'Cannot auto-detect sprite dimensions';
      });

      loadSprite(0);

      spriteSelector.innerHTML='';
      allSprites.forEach((_,i)=>{
        const opt = document.createElement('option');
        opt.value=i;
        opt.textContent=`Sprite ${i+1}`;
        spriteSelector.appendChild(opt);
      });
      spriteSelector.value=0;

    }catch(err){
      alert('Invalid JSON file: '+err);
    }
  };
  reader.readAsText(file);
});
</script>

</body>
</html>
